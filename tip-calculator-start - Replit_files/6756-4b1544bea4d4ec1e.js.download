!function(){try{var e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},r=Error().stack;r&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[r]="a8459532-1649-46f9-b813-aabacc4be92c",e._sentryDebugIdIdentifier="sentry-dbid-a8459532-1649-46f9-b813-aabacc4be92c")}catch(e){}}();var _global="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};_global.SENTRY_RELEASE={id:"2e833bf6"},(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[6756],{47:function(e,r,n){"use strict";n.d(r,{he:function(){return a},rc:function(){return l}});var t=n(36109),o=n(14224),i=n(91620).lW;function a(e){var r=e.split(".");if(4!==r.length)throw Error("Invalid token: should have exactly 4 parts: "+e);for(var n=r[2].replace(/-/g,"+").replace(/_/g,"/");n.length%4;)n+="=";var o=window.atob(n);if(o.length<64)throw Error("Invalid token: signed part is too short: "+o.length);var a=o.substring(0,o.length-64);return t.api.token.ReplToken.decode(new i(a,"base64"))}function l(e){return e.dotdevHostname.includes(".localhost")?"http://".concat(e.dotdevHostname):"https://".concat(e.dotdevHostname)}o.env.PROXY_SUFFIX,o.env.PROXY_FIREWALL_SUFFIX},14495:function(e,r,n){"use strict";n.d(r,{d:function(){return c},u:function(){return l}});var t=n(27387),o=n(66626),i=n(96583),a=n(75271);function l(){return s.apply(this,arguments)}function s(){return(s=(0,t._)(function(){return(0,i.Jh)(this,function(e){return"undefined"!=typeof document&&document.hidden?[2,new Promise(function(e){var r=function(){document.hidden||(document.removeEventListener("visibilitychange",r),e())};document.addEventListener("visibilitychange",r)})]:[2]})})).apply(this,arguments)}function c(){var e=(0,o._)((0,a.useState)(!1),2),r=e[0],n=e[1];return(0,a.useEffect)(function(){var e=function(){n(!document.hidden)};return document.addEventListener("visibilitychange",e),e(),function(){document.removeEventListener("visibilitychange",e)}},[]),r}},62699:function(e,r,n){"use strict";n.d(r,{U:function(){return a},b:function(){return l}});var t=n(3341),o=n.n(t),i=n(75271);function a(e){var r=e.repl,n=e.currentUser;return{asViewer:e.asViewer,repl:{__typename:"Repl",authorizations:r.authorizations,id:r.id,language:r.language,slug:r.slug},currentUser:n?{__typename:"CurrentUser",id:n.id,username:n.username,isSubscribed:n.isSubscribed,roles:n.roles}:void 0}}function l(e){var r=e?a(e):null,n=(0,i.useRef)(r);return o()(r,n.current)||(n.current=r),n.current}},71793:function(e,r,n){"use strict";n.d(r,{C:function(){return s},D:function(){return l}});var t=n(21262),o=n(71440);function i(){var e=(0,t._)(["\n  fragment CrosisContextCurrentUser on CurrentUser {\n    id\n    username\n    isSubscribed\n    roles {\n      id\n      name\n    }\n  }\n"]);return i=function(){return e},e}function a(){var e=(0,t._)(['\n  fragment CrosisContextRepl on Repl {\n    id\n    language\n    slug\n    user {\n      id\n      username\n    }\n    authorizations {\n      editFileContents {\n        isAuthorized\n      }\n    }\n    flagPid2: gateOnOwner(feature: "flag-pid2")\n    flagPid2DarkLaunch: gateOnOwner(feature: "flag-pid2-dark-launch")\n    flagPid2DarkLaunchWithHealthcheck: gateOnOwner(\n      feature: "flag-pid2-dark-launch-with-healthcheck"\n    )\n  }\n']);return a=function(){return e},e}var l=(0,o.Ps)(i()),s=(0,o.Ps)(a())},37782:function(e,r,n){"use strict";n.d(r,{ZP:function(){return v},em:function(){return p.e}});var t=n(27387),o=n(96583),i=n(10777),a=n(47),l=n(14495),s=n(93539),c=n(7391),u=n.n(c),f=n(92756),d=n(57997),h=n(34122),p=n(11346);function v(e){var r,n,c=e.onUnrecoverableError,p=e.onFirewallDenied,v=e.ctx,g={register:function(e,t){return n(),window.addEventListener("online",e),window.addEventListener("offline",t),r=function(){window.removeEventListener("online",e),window.removeEventListener("offline",t)},n},unregister:n=function(){r&&(r(),r=void 0)}},m=g.register,y=g.unregister;return(0,d.ZP)({fetchConnectionMetadata:h.Z,getOverrideClusterMetadata:s.Z,getDotdevUrl:a.rc,logger:i.kg,onUnrecoverableError:c,onFirewallDenied:p,performance:window.performance,preFetchConnectionMetadata:(0,t._)(function(){var e;return(0,o.Jh)(this,function(r){switch(r.label){case 0:if(window.performance.clearMarks(f.Iy.fetchConnectionMetadataPageInvisibleStart),window.performance.clearMarks(f.Iy.fetchConnectionMetadataPageInvisibleEnd),e=i.kg.timeStart(),window.performance.mark(f.Iy.fetchConnectionMetadataPageInvisibleStart),!("/migrateReplToNix"!==u().pathname))return[3,2];return[4,(0,l.u)()];case 1:r.sent(),r.label=2;case 2:window.performance.mark(f.Iy.fetchConnectionMetadataPageInvisibleEnd),e("page visible fetch connection metadata"),r.label=3;case 3:return[2]}})}),registerReconnectionMonitor:m,unregisterReconnectionMonitor:y,traceCtx:v})}},96082:function(e,r,n){"use strict";n.d(r,{JV:function(){return i},ZP:function(){return o}});var t=n(72100);function o(){return new t.EventEmitter}function i(e,r){return function(n){return e.on(r,n),function(){e.off(r,n)}}}},32581:function(e,r,n){"use strict";n.d(r,{Ci:function(){return i},cJ:function(){return a},hD:function(){return l}});var t=n(76539),o=/^(\.npm$|\.npm\/|__pycache__|\.cache|\.breakpoints|\.git$|\.git\/|\.upm$|\.upm\/|node_modules$|node_modules\/|_test_runner|\.local)/;function i(e){return o.test(e)}function a(e){return e.startsWith(".")&&!t.ZP.includes(e)}var l=[".git",".upm",".cache","__pycache__","node_modules","venv",".pythonlibs",".local"]},34366:function(e,r,n){"use strict";n.d(r,{Z:function(){return o}});var t=n(14224);function o(){var e;return(null===(e=window)||void 0===e?void 0:e.location.hostname)==="firewalledreplit.com"||"1"===t.env.FIREWALL_MODE}},95636:function(e,r,n){"use strict";n.d(r,{DW:function(){return p},GK:function(){return u},Rg:function(){return m},T0:function(){return s},eh:function(){return g},nO:function(){return d}});var t=n(27387),o=n(96583),i=n(85633),a=n(51305),l=n(18293),s="repl.it-web",c=i.g.getTracer(s);function u(e,r){return f.apply(this,arguments)}function f(){return(f=(0,t._)(function(e,r){return(0,o.Jh)(this,function(n){switch(n.label){case 0:return[4,d(a.D.active(),e,r)];case 1:return[2,n.sent()]}})})).apply(this,arguments)}function d(e,r,n){return h.apply(this,arguments)}function h(){return(h=(0,t._)(function(e,r,n){var t,a;return(0,o.Jh)(this,function(o){switch(o.label){case 0:t=c.startSpan(r,void 0,e),a=i.g.setSpan(e,t),o.label=1;case 1:return o.trys.push([1,3,4,5]),[4,n(a)];case 2:return[2,o.sent()];case 3:throw o.sent();case 4:return t.end(),[7];case 5:return[2]}})})).apply(this,arguments)}function p(e,r,n){return v.apply(this,arguments)}function v(){return(v=(0,t._)(function(e,r,n){var t,a;return(0,o.Jh)(this,function(o){switch(o.label){case 0:if(void 0!==e)return[3,2];return[4,n()];case 1:return[2,o.sent()];case 2:t=c.startSpan(r,void 0,e),a=i.g.setSpan(e,t),o.label=3;case 3:return o.trys.push([3,5,6,7]),[4,n(a,t)];case 4:return[2,o.sent()];case 5:throw o.sent();case 6:return t.end(),[7];case 7:return[2]}})})).apply(this,arguments)}function g(e,r){var n=c.startSpan(r,void 0,e),t=i.g.setSpan(e,n);return{span:n,childCtx:t}}function m(e){var r={};return new l.jf().inject(e,r,{set:function(e,r,n){e[r]=n}}),r}},57997:function(e,r,n){"use strict";n.d(r,{em:function(){return v.e},Y8:function(){return b},ZP:function(){return _}});var t=n(27387),o=n(41733),i=n(30509),a=n(98924),l=n(63257),s=n(96583),c=n(89232),u=n.n(c),f=n(28754),d=n(25722);function h(e){return p.apply(this,arguments)}function p(){return(p=(0,t._)(function(e){var r,n,t,o;return(0,s.Jh)(this,function(i){return r=e.client,n=e.args,t=e.env,o=e.noUserEnv,[2,new Promise(function(e){var i=r.openChannel({service:"exec"},function(r){var a=r.channel,l="";a.onCommand(function(e){e.output&&(l+=e.output)}),a.request({exec:{args:n,env:t,noUserEnv:null!=o&&o}}).then(function(r){if(r.channelClosed){e({error:"Channel closed",output:l||null});return}if("open"===a.status&&i(),r.error){e({error:r.error,output:l||null});return}e({output:l,error:null})})})})]})})).apply(this,arguments)}var v=n(11346),g=n(96082),m=n(19607),y=n(34366),C=n(39121),w=n(95636),E=n(49500),b=5900,S=.1>=Math.random();function D(e){return Math.min(1e3*Math.pow(2,e),3e4)+Math.floor(500*Math.random())}function _(e){var r,n=e.fetchConnectionMetadata,c=e.getOverrideClusterMetadata,p=e.getDotdevUrl,_=e.logger,k=e.onFirewallDenied,x=e.onUnrecoverableError,F=e.performance,O=e.preFetchConnectionMetadata,T=e.registerReconnectionMonitor,R=e.unregisterReconnectionMonitor,M=e.crosisTimeout,P=e.crosisWebSocketClass,N=e.traceCtx,I=(0,g.ZP)();I.setMaxListeners(1e3);var L=null,A=new f.KU;A.setUnrecoverableErrorHandler(x),k&&(A.onFirewallDenied=k),A.onDebugLog(function(e){if("breadcrumb"===e.type){r="container:state"===e.message?{containerState:e.data}:"data"in e?e.data:void 0,d.n_({category:"crosisV6",message:e.message,data:r});var r,n={replid:null==L?void 0:L.repl.id,language:null==L?void 0:L.repl.language};switch(e.message){case"timeout:hit":_.error("crosis connect timeout",n);break;case"onUnrecoverableError":var t=(0,o._)({errorMessage:e.data.message},n);_.error("crosis unrecoverable error",t);break;case"status:retrying":var i=e.data,l=i.error,s=(0,a._)(i,["error"]),c=(0,o._)({errorMessage:l.message},n,s);_.error("crosis retrying",c);break;case"status:connecting":case"status:reconnecting":var u=e.message.split(":")[1];_.info("crosis ".concat(u),(0,o._)({},n,"data"in e?e.data:void 0));break;case"websocket:polling fallback":_.info("crosis polling fallback",(0,o._)({},n))}}});var J=window.location.search.includes("debug=1");J&&A.onDebugLog(function(e){"log"===e.type&&E.log("in"===e.log.direction?"-->":"<--",e.log.channel.service,{cmd:e.log.cmd,channel:e.log.channel})});var U=function(e){var r=void 0;if(void 0!==N&&e.service){var n="";"string"==typeof e.service?n=e.service:L&&(n=e.service(L)),n&&(r=(0,w.eh)(N,"container.".concat(n,".openChannel")).span)}return r};return{logger:_,performance:F,onPortOpened:function(e){return I.on(v.z.PORT_OPEN,e),function(){I.removeListener(v.z.PORT_OPEN,e)}},onPortClosed:function(e){return I.on(v.z.PORT_CLOSE,e),function(){I.removeListener(v.z.PORT_CLOSE,e)}},onToast:function(e){return I.on(v.z.TOAST,e),function(){I.removeListener(v.z.TOAST,e)}},onConnectionStateChanged:function(e){return A.onConnectionStateChange(e)},connect:function(e){var r,d,h=this,p=e.context,g=e.fetchConnectionMetadataExtras,w=e.getMinimumRetryDelayMs,k=(0,a._)(e,["context","fetchConnectionMetadataExtras","getMinimumRetryDelayMs"]);A.getConnectionState()!==v.e.DISCONNECTED&&A.close(),L=p,T(function(){A.getConnectionState()===v.e.DISCONNECTED&&h.connect((0,o._)({context:p,fetchConnectionMetadataExtras:g,getMinimumRetryDelayMs:w},k))},function(){A.getConnectionState()!==v.e.DISCONNECTED&&h.close({expectReconnect:!0})});var R=this,N=(r=(0,t._)(function(e){var r,n,t,i,a,l;return(0,s.Jh)(this,function(s){switch(s.label){case 0:if(r=e.chan0,n=e.gurl,t=e.isFirst,"open"!==r.status)return[2];return i=_.timeStart({gurl:n}),a=setTimeout(function(){_.error("ping with no response",{gurl:n}),R.connect((0,o._)({context:p,fetchConnectionMetadataExtras:g,getMinimumRetryDelayMs:w},k))},3e4),[4,r.request({ping:{}})];case 1:if(l=s.sent().channelClosed,clearTimeout(a),l)return[2];return t?i("latency to pid1",{type:"startup"}):S&&i("latency to pid1",{type:"periodic"}),setTimeout(function(){return N({chan0:r,gurl:n,isFirst:!1})},1e3),[2]}})}),function(e){return r.apply(this,arguments)}),U={getNextRetryDelayMs:function(){for(var e=arguments.length,r=Array(e),n=0;n<e;n++)r[n]=arguments[n];return Math.max(D.apply(void 0,(0,l._)(r)),w())},context:p,reuseConnectionMetadata:!0,fetchConnectionMetadata:(d=(0,t._)(function(e){var r,t,a,l,u;return(0,s.Jh)(this,function(s){switch(s.label){case 0:if("function"!=typeof O)return[3,2];return[4,O()];case 1:s.sent(),s.label=2;case 2:if("function"!=typeof c)return[3,4];return[4,c()];case 3:return t=s.sent(),[3,5];case 4:t=null,s.label=5;case 5:if(r=t,e.aborted)return[2,{error:f.gS.Aborted}];a=_.timeStart({hasCustomFetch:!!k.fetchConnectionMetadata}),s.label=6;case 6:if(s.trys.push([6,11,,12]),!k.fetchConnectionMetadata)return[3,8];return[4,k.fetchConnectionMetadata()];case 7:return l=s.sent(),[3,10];case 8:return[4,n((0,o._)({asViewer:p.asViewer,replId:p.repl.id,isLoggedIn:!!p.currentUser,overrideClusterMetadata:r},g))];case 9:l=s.sent(),s.label=10;case 10:return[3,12];case 11:if(u=s.sent(),e.aborted)return[2,{error:f.gS.Aborted}];switch(u&&u.statusCode){case 400:case 401:case 403:throw new C.cb(u.statusCode);case 408:case 409:case 429:case 500:case 502:case 503:case 504:case 526:return _.warn("Retriable error while fetching connection metadata",{statusCode:u.statusCode,originalMessage:u.message}),[2,{error:f.gS.Retriable}]}throw u;case 12:if(e.aborted)return[2,{error:f.gS.Aborted}];return J&&E.log("connecting",l),a("fetched connection metadata"),[2,(0,i._)((0,o._)({},l),{error:null})]}})}),function(e){return d.apply(this,arguments)})};M&&M>0&&(U.timeout=M),P?U.WebSocketClass=P:"undefined"==typeof WebSocket&&(U.WebSocketClass=u()),(0,y.Z)();var V=F.now(),q=0;A.open(U,function(e){var r,n=e.channel;J&&E.log("connected",{replId:p.repl.id});var t=n.onCommand(function(e){switch(e.body){case"portOpen":if(!e.portOpen)throw Error("portOpen only handles portOpen commands");var r=!!e.portOpen.forwarded,n=e.portOpen,t=n.address,o=n.cmdline,i=n.cgroup,a=n.pid,l=e.portOpen.port||0;if(8284===l||5901===l)return;I.emit(v.z.PORT_OPEN,{port:l,externalPort:e.portOpen.externalPort,isVnc:l===b,isForwarded:r,address:t,cmdline:o,cgroup:i,pid:a});break;case"portClose":if(!e.portClose)throw Error("portClose only handles portClose commands");var s=e.portClose.port||0,c=e.portClose.address;if(8284===s||5901===s)return;I.emit(v.z.PORT_CLOSE,{port:s,externalPort:e.portClose.externalPort,isVnc:s===b,address:c});break;case"protocolError":x(new m.Z("goval panic").setExtra("message",null!==(f=null===(u=e.protocolError)||void 0===u?void 0:u.text)&&void 0!==f?f:"protocol error"));break;case"toast":var u,f,d,h=null===(d=e.toast)||void 0===d?void 0:d.text;if(!h)break;I.emit(v.z.TOAST,h)}});N({chan0:n,gurl:null===(r=A.getConnectionMetadata())||void 0===r?void 0:r.gurl,isFirst:!0}),window.v6ws=A.ws;var o=F.now()-V;return _.info("connected to pid1",{time:o,reconnectCount:q,replid:p.repl.id,language:p.repl.language}),function(e){var r=e.willReconnect;if(t(),!r){L=null;return}V=F.now(),q++}})},openChannel:function(e,r){var n=U(e);return A.openChannel(e,function(e){var t=e.channel.onCommand(function(e){if("protocolError"===e.body){var r,n;x(new m.Z("goval panic").setExtra("message",null!==(n=null===(r=e.protocolError)||void 0===r?void 0:r.text)&&void 0!==n?n:"protocol error"))}}),o=r(e);return void 0!==n&&n.end(),function(e){o&&o(e),t&&t()}})},getConnectionState:function(){return A.getConnectionState()},exec:(0,t._)(function(){var e,r,n,t=arguments;return(0,s.Jh)(this,function(o){for(r=Array(e=t.length),n=0;n<e;n++)r[n]=t[n];return[2,h({client:A,args:r})]})}),execImmediately:(0,t._)(function(){var e,r,n,t=arguments;return(0,s.Jh)(this,function(o){for(r=Array(e=t.length),n=0;n<e;n++)r[n]=t[n];return[2,h({client:A,args:r,noUserEnv:!0})]})}),execWithEnv:(r=(0,t._)(function(e){var r,n,t,o=arguments;return(0,s.Jh)(this,function(i){for(n=Array((r=o.length)>1?r-1:0),t=1;t<r;t++)n[t-1]=o[t];return[2,h({client:A,args:n,env:e})]})}),function(e){return r.apply(this,arguments)}),close:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{expectReconnect:!1};A.getConnectionState()!==v.e.DISCONNECTED&&A.close(e)},destroy:function(){A.destroy(),I.removeAllListeners(),R()},client:function(){return A},focus:function(){var e=A.getChannel(0);e&&e.send({focused:{}})},getConnectionMetadata:function(){return A.getConnectionMetadata()},getContext:function(){return L},getDotdevUrl:function(){var e=A.getConnectionMetadata();if(!e||A.getConnectionState()!==v.e.CONNECTED)throw Error("Cannot get dot dev url when container is not connected");return p(e)},unrecoverableError:function(e,r){A.destroy(),I.removeAllListeners(),x(r?m.Z.wrap(e).setExtras(r):e)}}}},39121:function(e,r,n){"use strict";n.d(r,{Gs:function(){return o},ZP:function(){return f},cb:function(){return d}});var t,o,i=n(12285),a=n(4955),l=n(66626),s=n(14105),c=n(9670);(t=o||(o={})).NotFound="NotFound",t.NotAllowed="NotAllowed",t.ConcurrentReplLimit="ConcurrentReplLimit",t.FirewallDenied="FirewallDenied",t.LanguageTokenDenied="LanguageTokenDenied",t.RequiresRefresh="RequiresRefresh";var u={"repl not found":"NotFound","not allowed to run at this time":"NotAllowed","language tokens are only for logged out people.":"LanguageTokenDenied","connect to unfirewalled repl from firewall mode":"FirewallDenied","user is required to refresh":"RequiresRefresh"};function f(e){var r=!0,n=!1,t=void 0;try{for(var o,i=Object.entries(u)[Symbol.iterator]();!(r=(o=i.next()).done);r=!0){var a=(0,l._)(o.value,2),s=a[0],c=a[1];if(e.message.toLowerCase().includes(s))return c}}catch(e){n=!0,t=e}finally{try{r||null==i.return||i.return()}finally{if(n)throw t}}return null}var d=function(e){(0,a._)(n,e);var r=(0,c._)(n);function n(e){return(0,i._)(this,n),r.call(this,"user is required to refresh: "+e)}return n}((0,s._)(Error))},11346:function(e,r,n){"use strict";n.d(r,{e:function(){return i.em},z:function(){return o}});var t,o,i=n(28754);(t=o||(o={})).CONNECTION_STATE_CHANGE="CONNECTION_STATE_CHANGE",t.PORT_OPEN="PORT_OPEN",t.PORT_CLOSE="PORT_CLOSE",t.TOAST="TOAST"},12467:function(e,r,n){"use strict";n.d(r,{q:function(){return J},Z:function(){return U}});var t=n(27387),o=n(41733),i=n(30509),a=n(78950),l=n(63257),s=n(96583),c=n(80403),u=n(36109),f=n(25722),d=n(62764),h=n(70090),p=n(43257),v=n(17437),g=n(24986),m=n(61932),y=n(65883),C=n(35370),w=n(32581),E=n(72106),b=n(4377),S=n(12285),D=n(4955),_=n(9670),k=n(72100),x=n(51228),F=n(86763),O=n.n(F),T=n(73878),R=n(66791);function M(e,r){var n=!0,t=!1,o=void 0;try{for(var i,a=r[Symbol.iterator]();!(n=(i=a.next()).done);n=!0){var l=i.value;switch(l){case T.Df.NotFound:if(e.includes("no such file")||e.includes("file does not exist"))return T.Df.NotFound;break;case T.Df.AlreadyExists:if(e.includes("file exist"))return T.Df.AlreadyExists;break;case T.Df.NotDirectory:if(e.includes("not a directory"))return T.Df.NotDirectory;break;case T.Df.IsDirectory:if(e.includes("is a directory"))return T.Df.IsDirectory;break;case T.Df.InvalidPath:if(e.includes("absolute paths are not supported"))return T.Df.InvalidPath;break;case T.Df.DiskQuotaExceeded:if(e.includes("disk quota exceeded"))return T.Df.DiskQuotaExceeded;break;case T.Df.PermissionDenied:if(e.includes("permission denied"))return T.Df.PermissionDenied;break;case T.Df.FileSystemUnavailable:if(e.includes("input/output error"))return T.Df.FileSystemUnavailable;break;default:(0,R.Z)(l)}}}catch(e){t=!0,o=e}finally{try{n||null==a.return||a.return()}finally{if(t)throw o}}return null}var P=n(63483),N=n(92756),I=n(52589),L=n(19607),A=function(e){(0,D._)(n,e);var r=(0,_._)(n);function n(e,a,l,f,d,v){(0,S._)(this,n),(E=r.call(this)).writeChanges=function(e,r){if(!E.channel&&!E.isReconnecting)throw Error("Trying to send changes before ever coming online");E.isReconnecting&&(E.didEditOffline=!0);var n=(0,P.ed)(e,E.localContent),t=n.op,i=n.docAfter;if(.1>Math.random()){var a=(0,P.f5)(x.type.apply(E.localContent,t)),l=e.apply((0,P.tT)(E.localContent));(a!==l.sliceString(0)||a!==(0,P.f5)(i))&&E.onError("changeset to op mismatch",{originalError:null,changes:e,otContent:a,changeSetContent:l,docAfter:i})}var s=(null==r?void 0:r.author)==="ghostwriter"?{author:u.api.OTPacket.Author.GHOSTWRITER}:{};E.metadata=(0,o._)({},E.metadata,s);try{E.pending=x.type.compose(E.pending,t)}catch(e){throw L.Z.wrap(e).setExtras({op:t,pending:E.pending})}E.localContent=i,0!==E.pending.length?E.emit("fileDirty"):E.commitPromise&&E.emit("commitStart"),E.debounceSend()},E.updateCursors=function(e){E.pendingCursors=e,E.debounceSend()},E.isClean=function(){return E.committedVersion===E.version&&0===E.inflight.length&&0===E.pending.length},E.onError=function(e,r){if(r.originalError){var n="string"==typeof r.originalError?r.originalError:r.originalError.message,t=M(n,[T.Df.NotFound,T.Df.IsDirectory,T.Df.DiskQuotaExceeded,T.Df.InvalidPath,T.Df.PermissionDenied,T.Df.FileSystemUnavailable]);if(t){E.emit("fsError",t,n);return}}E.destroy();var a=Error("OT Error: "+e);E.emit("error",a,(0,i._)((0,o._)({},r),{filePath:E.linkedFile,version:E.version}))},E.sendOp=function(){if(E.channel&&"open"===E.channel.status&&!E.isReconnecting&&!(E.inflight.length>0)){if(0!==E.pending.length){var e=(0,P.gR)(E.pending);E.inflight=E.pending,E.pending=[],E.inflightOpsPromise=E.channel.request({ot:(0,o._)({spookyVersion:E.version,op:e},E.metadata)}),E.metadata={},E.inflightOpsPromise.then(function(r){r.error&&E.onError("error accepting packet",{originalError:r.error,op:e})})}if(0!==E.pendingCursors.length){var r=!0,n=!1,t=void 0;try{for(var i,a=E.flushedCursorIds[Symbol.iterator]();!(r=(i=a.next()).done);r=!0){var l=i.value;E.channel.send({otDeleteCursor:{id:l}})}}catch(e){n=!0,t=e}finally{try{r||null==a.return||a.return()}finally{if(n)throw t}}E.flushedCursorIds=[];var s=!0,c=!1,u=void 0;try{for(var f,d=E.pendingCursors[Symbol.iterator]();!(s=(f=d.next()).done);s=!0){var h=f.value,p=Number(Math.random().toString().split(".")[1]).toString(36);E.flushedCursorIds.push(p),E.channel.send({otNewCursor:(0,o._)({id:p,user:E.user},h)})}}catch(e){c=!0,u=e}finally{try{s||null==d.return||d.return()}finally{if(c)throw u}}E.pendingCursors=[]}}},E.handlePacket=function(e,r){var n=e.op,t=e.version,o=e.crc32,i=e.userId,a=r.overrideReconnectingBuffer;if(E.isReconnecting&&!a){E.bufferedReconnectingOps.push({crc32:o,op:n,version:t,userId:i});return}if(-1===E.version){E.onError("Got packet while version is still -1, expected version to be set in handleStatus",{originalError:null});return}if(E.version++,t!==E.version){var l={originalError:null,expectedVersion:E.version,receivedVersion:t,incomingOp:n};E.logger.error("OT Error: invalid server version",(0,N.P1)({details:l})),E.onError("invalid server version",l);return}try{E.serverContent=x.type.apply(E.serverContent,n)}catch(e){E.onError("unable to apply updated content",{originalError:e,incomingOp:n});return}var s=h.str(E.serverContent)>>>0;if(s!==o){var c={originalError:null,incomingVersion:t,server:o,client:s,incomingOp:n};E.logger.error("OT Error: crc32 mismatch",(0,N.P1)({details:c})),E.onError("crc32 mismatch",c);return}if(E.uncommittedOps.push({version:t,crc32:o,op:n,userId:i}),E.dataloss&&E.shouldTrackDataLoss&&E.dataloss.storeOp({replId:E.replId,filePath:E.linkedFile.toString(),opType:"latestOp",op:{version:t,crc32:o},logger:E.logger,isReconnecting:E.isReconnecting}),JSON.stringify(n)===JSON.stringify(E.inflight)){E.dataloss&&E.shouldTrackDataLoss&&E.dataloss.storeOp({replId:E.replId,filePath:E.linkedFile.toString(),opType:"latestOwnOp",op:{version:t,crc32:o},logger:E.logger,isReconnecting:E.isReconnecting}),E.debounceCommit(),E.inflight=[],E.inflightOpsPromise=null,E.debounceSend(),E.debounceSend.flush();return}if(E.commitPromise||E.emit("fileDirty"),E.debounceCommit(),E.hasUncommittedMultiplayerOps=!0,E.inflight.length){var u=x.type.transform(E.inflight,n,"right");n=x.type.transform(n,E.inflight,"left"),E.inflight=u}if(E.pending.length){var f=x.type.transform(E.pending,n,"right");n=x.type.transform(n,E.pending,"left"),E.pending=f}var d=(0,P.mt)(n,E.localContent),p=d.changes,v=d.docAfter;if(.1>Math.random()){var g=(0,P.f5)(x.type.apply(E.localContent,n)),m=p.apply((0,P.tT)(E.localContent));(g!==m.sliceString(0)||g!==(0,P.f5)(v))&&E.onError("op to changeset mismatch",{originalError:null,op:n,otContent:g,changeSetContent:m,docAfter:v})}E.localContent=v,E.emit("changes",p,i)},E.handleNewCursor=function(e){E.emit("cursor",e)},E.handleDeleteCursor=function(e){var r=e.id;E.emit("removeCursor",r)};var g,m,y,C,w,E,D=(0,b._)(E);E.handleStatus=(g=(0,t._)(function(e){var r,n,t,o,i;return(0,s.Jh)(this,function(a){switch(a.label){case 0:if(!D.channel||"open"!==D.channel.status)return[2];if(e.linkedFile){if(null==e.contents)return D.onError("expected status contents, got null or undefined",{originalError:null}),[2];if(null==e.cursors)return D.onError("expected status cursors, got null or undefined",{originalError:null}),[2];if(null==e.version)return D.onError("expected status version, got null or undefined",{originalError:null}),[2];if(D.isReconnecting)return D.handleReconnect(e.contents,e.version),[2];return D.dataloss&&D.shouldTrackDataLoss&&D.dataloss.checkAndTrack({serverContent:e.contents,serverVersion:e.version,replId:D.replId,filePath:D.linkedFile.toString(),fetchOps:D.fetchOps,logger:D.logger}),D.serverContent=e.contents,D.localContent=D.serverContent,D.version=e.version,D.emit("firstConnect"),D.emit("changes",c.as.of({from:0,insert:D.serverContent},0)),e.cursors.forEach(D.handleNewCursor),D.emit("fileDirty"),D.debounceCommit(),[2]}return[4,D.channel.request({otLinkFile:{file:{path:D.linkedFile.toString()}}})];case 1:if((n=a.sent()).channelClosed)return[2];if(n.error)return D.onError("link file error "+n.error.replace(D.linkedFile.toString(),"$FILENAME"),{originalError:n.error}),[2];if(!n.otLinkFileResponse)return D.onError("unexpected link file response: "+JSON.stringify(n.toJSON()),{originalError:null}),[2];if(t=n.otLinkFileResponse.version,i=p.Z.from(null!==(o=null===(r=n.otLinkFileResponse.linkedFile)||void 0===r?void 0:r.content)&&void 0!==o?o:"").toString(),D.isReconnecting)return D.handleReconnect(i,t),[2];return D.dataloss&&D.shouldTrackDataLoss&&D.dataloss.checkAndTrack({serverContent:i,serverVersion:t,replId:D.replId,filePath:D.linkedFile.toString(),fetchOps:D.fetchOps,logger:D.logger}),D.serverContent=i,D.localContent=D.serverContent,D.version=t,D.committedVersion=t,D.committedContent=D.serverContent,D.emit("firstConnect"),D.emit("changes",c.as.of({from:0,insert:D.serverContent},0)),[2]}})}),function(e){return g.apply(this,arguments)});var _=(0,b._)(E);E.handleReconnect=(m=(0,t._)(function(e,r){var n,t,a,l,c,u,f,d,h,p,v,g,m,y,C,w,E,b,S,D,k,F,O,T,R,M,P,L,A,J,U,V,q,Z,z,W,B,Q,H,K,Y,G,X,$,j,ee,er,en,et,eo,ei;return(0,s.Jh)(this,function(s){switch(s.label){case 0:if(!_.timeDisconnected)throw Error("wat");if(n=Date.now()-_.timeDisconnected,t={case:"other",remoteContent:e,localContent:_.localContent},a=function(t){_.reconnectTrackedData=(0,i._)((0,o._)({},t),{serverVersion:r,ourVersion:_.version,ourCommittedVersion:_.committedVersion,areContentsEqual:_.serverContent===e,areCommittedContentsEqual:_.committedContent===e,didReceiveOpsWhileReconnecting:!!_.bufferedReconnectingOps.length,didEditOffline:_.didEditOffline,hasPendingOps:!!_.pending.length,hasUncommittedMultiplayerOps:_.hasUncommittedMultiplayerOps,disconnectDuration:n});var a={};("has_inflight_happy_path_ops_reached"===t.case||"has_inflight"===t.case||"multiplayer"===t.case)&&.1>Math.random()&&(a={hasAdditionalLogs:!0,localContent:String(_.localContent),ourContent:String(_.serverContent),ourCommittedContent:String(_.committedContent),ourInflight:JSON.stringify(_.inflight),ourPending:JSON.stringify(_.pending),serverContent:String(e)}),_.logger.info("OT Client: Reconnect",(0,N.P1)((0,o._)({},_.reconnectTrackedData,a))),_.track&&_.track(I.U3.FILE_RECONNECTED_STATUS2,_.reconnectTrackedData)},l=function(e,r){a({case:e,originCase:r,prompted:!1}),_.isReconnecting=!1,_.bufferedReconnectingOps=[],_.didEditOffline=!1,_.timeDisconnected=null,_.debounceSend(),_.debounceCommit(),_.emit("transparentReconnect",{case:e,originCase:r})},c=function(n){if(t.remoteContent===t.localContent){_.version=r,_.committedVersion=r,_.localContent=e,_.committedContent=e,_.serverContent=e,_.inflight=[],_.pending=[],l("unprompted_because_identical",n);return}a({case:n,prompted:!0}),t.case=n,_.emit("promptUserReconnect",t)},_.inflight.length){if(r===_.version&&_.serverContent===e)return _.pending=x.type.compose(_.inflight,_.pending),_.inflight=[],_.inflightOpsPromise=null,l("has_inflight_happy_path_ops_unreached"),[2];u=!1,f=_.serverContent;try{f=x.type.apply(f,_.inflight)}catch(e){u=!0}if(!u&&_.version+1===r&&f===e)return _.inflight=[],_.inflightOpsPromise=null,_.serverContent=e,_.version=r,l("has_inflight_happy_path_ops_reached"),[2];return c("has_inflight"),[2]}if(_.hasUncommittedMultiplayerOps)return c("multiplayer"),[2];if(_.version===r){if(e===_.serverContent)return l("happy_path"),[2];return c("same_version_different_content"),[2]}if(_.committedVersion===r){d=e;try{h=!0,p=!1,v=void 0;try{for(g=_.uncommittedOps[Symbol.iterator]();!(h=(m=g.next()).done);h=!0)y=m.value.op,d=x.type.apply(d,y)}catch(e){p=!0,v=e}finally{try{h||null==g.return||g.return()}finally{if(p)throw v}}}catch(e){return c("same_committed_version_unable_to_apply_ops"),[2]}if(d===_.serverContent){C=[],w=!0,E=!1,b=void 0;try{for(S=_.uncommittedOps[Symbol.iterator]();!(w=(D=S.next()).done);w=!0)k=D.value.op,C=x.type.compose(C,k)}catch(e){E=!0,b=e}finally{try{w||null==S.return||S.return()}finally{if(E)throw b}}return _.pending=x.type.compose(C,_.pending),_.uncommittedOps=[],_.version=r,_.serverContent=e,l("happy_path_uncommitted"),[2]}return c("same_committed_version_different_content_fixed"),[2]}if(!(_.version<r))return[3,3];return[4,_.fetchOps(_.version+1,r)];case 1:F=s.sent(),O=!1,T=_.serverContent;try{R=!0,M=!1,P=void 0;try{for(L=F[Symbol.iterator]();!(R=(A=L.next()).done);R=!0)J=A.value.op,T=x.type.apply(T,J)}catch(e){M=!0,P=e}finally{try{R||null==L.return||L.return()}finally{if(M)throw P}}}catch(e){O=!0}if(!O&&T===e){U=!0,V=!1,q=void 0;try{for(Z=F[Symbol.iterator]();!(U=(z=Z.next()).done);U=!0)W=z.value,_.handlePacket(W,{overrideReconnectingBuffer:!0})}catch(e){V=!0,q=e}finally{try{U||null==Z.return||Z.return()}finally{if(V)throw q}}B=!0,Q=!1,H=void 0;try{for(K=_.bufferedReconnectingOps[Symbol.iterator]();!(B=(Y=K.next()).done);B=!0)G=Y.value,_.handlePacket(G,{overrideReconnectingBuffer:!0})}catch(e){Q=!0,H=e}finally{try{B||null==K.return||K.return()}finally{if(Q)throw H}}return l("happy_path_server_ahead"),[2]}return[4,_.fetchOps(_.committedVersion+1,r)];case 2:X=s.sent(),$=!1,j=_.committedContent;try{ee=!0,er=!1,en=void 0;try{for(et=X[Symbol.iterator]();!(ee=(eo=et.next()).done);ee=!0)ei=eo.value.op,j=x.type.apply(j,ei)}catch(e){er=!0,en=e}finally{try{ee||null==et.return||et.return()}finally{if(er)throw en}}}catch(e){$=!0}if(!$&&j===e)return c("happy_path_uncommitted_server_ahead"),[2];return c("uncommitted_server_ahead"),[2];case 3:return c("other"),[2]}})}),function(e,r){return m.apply(this,arguments)});var k=(0,b._)(E);E.flush=(0,t._)(function(){return(0,s.Jh)(this,function(e){switch(e.label){case 0:return[4,k.commitPromise];case 1:return e.sent(),k.debounceCommit(),k.debounceCommit.flush(),[4,k.commitPromise];case 2:return e.sent(),[2]}})}),E.isFileSaved=function(){return!0};var F=(0,b._)(E);E.fetchOps=(y=(0,t._)(function(e,r){var n;return(0,s.Jh)(this,function(t){switch(t.label){case 0:if(!F.channel)throw Error("No channel, cannot fetchOps");return[4,F.channel.request({otFetchRequest:{versionFrom:e,versionTo:r}})];case 1:if((n=t.sent()).channelClosed)throw Error("Channel closed while requesting");if(n.error)throw Error("Fetch ops returned an error: "+n.error);if(!n.otFetchResponse)throw Error("Expected otFetchResponse");if(!n.otFetchResponse.packets)throw Error("Expected otFetchResponse.packets");return[2,n.otFetchResponse.packets.map(function(e){var r=e.crc32,n=e.op,t=e.version,o=e.userId,i=e.committed,a=e.author;if(null==r)throw Error("Expected crc32 in packet");if(null==n)throw Error("Expected op in packet");if(null==t)throw Error("Expected version in packet");return{crc32:r,version:t,op:(0,P.ug)(n),userId:o,timestamp:i?1e3*i.seconds:0,author:a}})]}})}),function(e,r){return y.apply(this,arguments)});var R=(0,b._)(E);E.fetchChanges=(C=(0,t._)(function(e,r,n){var t,o;return(0,s.Jh)(this,function(i){switch(i.label){case 0:return[4,R.fetchOps(e,r)];case 1:return t=i.sent(),o=n,[2,t.map(function(e){var r=e.op,n=e.version,t=e.userId,i=e.timestamp,a=e.crc32,l=(0,P.mt)(r,o),s=l.changes,c=l.docAfter,u=s.invert((0,P.tT)(o));return o=c,{changes:s,invertedChanges:u,userId:t,version:n,timestamp:i,crc32:a}})]}})}),function(e,r,n){return C.apply(this,arguments)});var A=(0,b._)(E);E.transformSelection=(w=(0,t._)(function(e){var r,n,t,o,i,a,l,c;return(0,s.Jh)(this,function(s){switch(s.label){case 0:if(r=e.indexStart,n=e.indexEnd,t=e.versionFrom,o=e.versionTo,!A.channel)throw Error("No channel, cannot transformSelection");return[4,A.channel.request({otTransformSelectionRequest:{indexStart:r,indexEnd:n,versionFrom:t,versionTo:o}})];case 1:if(!(i=s.sent()).otTransformSelectionResponse)throw Error("Expected otTransformSelectionResponse");return[2,{indexStart:null!==(a=i.otTransformSelectionResponse.indexStart)&&void 0!==a?a:0,indexEnd:null!==(l=i.otTransformSelectionResponse.indexEnd)&&void 0!==l?l:0,version:null!==(c=i.otTransformSelectionResponse.version)&&void 0!==c?c:0}]}})}),function(e){return w.apply(this,arguments)}),E.getLocalContent=function(){return(0,P.f5)(E.localContent)},E.getRawLocalContent=function(){return E.localContent},E.shouldTrackDataLoss=!1,E.replId="",E.linkedFile=e,E.channel=null,E.inflight=[],E.inflightOpsPromise=null,E.uncommittedOps=[],E.hasUncommittedMultiplayerOps=!1,E.committedVersion=-1,E.isReconnecting=!1,E.bufferedReconnectingOps=[],E.didEditOffline=!1,E.pending=[],E.metadata={},E.version=-1,E.serverContent="",E.localContent="",E.committedContent="",E.flushedCursorIds=[],E.pendingCursors=[],E.user=null,E.flushFailed=0,E.debounceSend=O()(function(){return E.sendOp()},20,{maxWait:60});var J=O()(function(){return E.commitToDisk()},1e3,{maxWait:3e3}),U=function(){if(!E.channel)throw Error("Tryna commit while offline");if(E.isReconnecting)throw Error("Committing while reconnecting");return J()};U.cancel=J.cancel,U.flush=J.flush,E.debounceCommit=U,E.commitPromise=null,E.timeDisconnected=null;var V=!1;return E.destroy=function(){V=!0},E.logger=f,E.track=v,E.dataloss=d,l.then(function(){V||(E.destroy=a.openChannel({service:"ot",name:"ot:".concat(e)},function(r){var n=r.channel,t=r.context;return E.shouldTrackDataLoss=!window.navigator.userAgent.includes("Firefox"),E.replId=t.repl.id,E.dataloss&&E.shouldTrackDataLoss&&E.dataloss.ensureTrackedFile({replId:E.replId,filePath:e.toString()}),E.user=t.currentUser?{name:t.currentUser.username,id:t.currentUser.id}:null,E.channel=n,n.onCommand(function(e){switch(e.body){case"ot":if(!e.ot||null==e.ot.op||null==e.ot.spookyVersion||null==e.ot.crc32){E.onError("missing data in ot packet",{originalError:null,op:null===(r=e.ot)||void 0===r?void 0:r.op,spookyVersion:null===(n=e.ot)||void 0===n?void 0:n.spookyVersion,crc32:null===(t=e.ot)||void 0===t?void 0:t.crc32});return}if(-1===E.version)return;var r,n,t,o,i={crc32:e.ot.crc32,op:(0,P.ug)(e.ot.op),version:e.ot.spookyVersion,userId:null!==(o=e.ot.userId)&&void 0!==o?o:0};return E.handlePacket(i,{overrideReconnectingBuffer:!1});case"otstatus":return E.handleStatus(e.otstatus);case"error":if(e.ref)return;return E.onError("Unknown protocol error OT channel",{originalError:e.error||"no error"});case"otNewCursor":return E.handleNewCursor(e.otNewCursor);case"otDeleteCursor":return E.handleDeleteCursor(e.otDeleteCursor)}}),function(){E.channel=null,E.isReconnecting=!0,E.debounceSend.cancel(),E.debounceCommit.cancel(),E.timeDisconnected||(E.timeDisconnected=Date.now())}}))}),E}return n.prototype.commitToDisk=function(){var e=this;return(0,t._)(function(){var r,n,t,o,i,a;return(0,s.Jh)(this,function(l){switch(l.label){case 0:if(!e.channel)throw Error("Tryna commit while offline");if("open"!==e.channel.status)return[2];if(e.isReconnecting)throw Error("Committing while reconnecting");if(e.isClean())return[2];if(e.commitPromise)return e.debounceCommit(),[2];if(r=function(){},e.commitPromise=new Promise(function(e){return r=e}),!e.inflightOpsPromise)return[3,2];return[4,e.inflightOpsPromise];case 1:if(l.sent().channelClosed)return e.commitPromise=null,r(),[2];l.label=2;case 2:if(!(e.pending.length>0))return[3,4];if(e.debounceSend(),e.debounceSend.flush(),!e.inflightOpsPromise)return e.commitPromise=null,r(),e.onError("expected inflight promise",{originalError:null}),[2];return[4,e.inflightOpsPromise];case 3:if(l.sent().channelClosed)return e.commitPromise=null,r(),[2];l.label=4;case 4:return e.emit("commitStart"),n=e.version,t=e.serverContent,[4,e.channel.request({flush:{consistency:u.api.Flush.Consistency.Disk}})];case 5:if((o=l.sent()).channelClosed)return e.flushFailed=0,e.commitPromise=null,r(),[2];if("ok"!==o.body){if(e.commitPromise=null,r(),M(i=o.error||o.toString(),[T.Df.NotFound,T.Df.AlreadyExists,T.Df.NotDirectory,T.Df.IsDirectory,T.Df.DiskQuotaExceeded]))return e.onError("unable to flush",{originalError:i}),[2];return e.flushFailed++,setTimeout(function(){!e.isReconnecting&&e.channel&&"open"===e.channel.status&&e.debounceCommit()},Math.min(Math.random()*(Math.pow(2,e.flushFailed)-1)*1e3,1024e3)),[2]}return e.dataloss&&e.shouldTrackDataLoss&&(a=e.uncommittedOps[e.uncommittedOps.length-1])&&e.dataloss.storeOp({replId:e.replId,filePath:e.linkedFile.toString(),op:{crc32:a.crc32,version:a.version},opType:"latestFlushedOp",logger:e.logger,isReconnecting:e.isReconnecting}),e.uncommittedOps=[],e.hasUncommittedMultiplayerOps=!1,e.committedVersion=n,e.committedContent=t,e.flushFailed=0,e.emit("commitComplete",n),e.isClean()&&e.emit("fileClean"),e.commitPromise=null,r(),[2,o]}})})()},n}(k.EventEmitter),J="SYNTHETIC_FILE_PATH.sql";function U(e){var r,n,b=e.container,S=e.dataloss,D=e.track,_=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e4,r=[];return{enqueue:function(n){for(var t=arguments.length,o=Array(t>1?t-1:0),i=1;i<t;i++)o[i-1]=arguments[i];if(r.length>=e)throw Error("fs: We retried too many things during a closed channel.");return new Promise(function(e){r.push(e)}).then(function(){return n.apply(void 0,(0,l._)(o))})},flush:function(){r.splice(0,r.length).forEach(function(e){return e()})}}}(),k=_.enqueue,x=_.flush,F=!1,O=null,R=null,P=null,N=0,I=new Map,L=new Map,U=new Map,V=[],q=new Map,Z=new Set;b.openChannel({service:"fsevents"},function(e){var r=e.channel;O=r,r.onCommand(function(e){if("fileEvent"===e.body){if(!e.fileEvent)throw Error("Expected fileEvent");var r=e.fileEvent,n=r.file,t=r.dest,o=r.op;if(n){var i=n.path;if(null!==i&&null!==o&&void 0!==i&&void 0!==o){var a=(0,y.S1)(i);if(Y(),I.get(a)||n.type===u.api.File.Type.DIRECTORY)l=T.Tv.Directory;else{var l,s,c=Array.from(I.keys()).find(function(e){return(0,y.MO)(e,a)}),d=c&&(null===(s=I.get(c))||void 0===s?void 0:s.children.find(function(e){return e.filename===(0,y.Bf)(a)}));l=d?d.type:T.Tv.File}switch(o){case u.api.FileEvent.Op.Create:et({eventType:T.kS.Create,node:{path:a,type:l}});break;case u.api.FileEvent.Op.Modify:if(l===T.Tv.Directory){f.$e(function(e){e.setTag("service","fs"),e.setExtra("path-str",i),e.setExtra("op",o),e.setExtra("file-type",l),f.Tb(Error("Unexpected modify directory event"))});break}et({eventType:T.kS.Modify,node:{path:a,type:l}});break;case u.api.FileEvent.Op.Remove:et({eventType:T.kS.Delete,node:{path:a,type:l}});break;case u.api.FileEvent.Op.Move:if(null==t||null==t.path)throw Error("Expected dest path");var h=t.path;et({eventType:T.kS.Move,node:{path:a,type:l},to:(0,y.S1)(h)})}}}}});var n=(0,l._)(new Set((0,l._)(I.keys()).concat((0,l._)(L.keys()),(0,l._)(U.keys()))));return n.length&&r.send({subscribeFile:{files:n.map(function(e){return{path:e.toString()}})}}),function(){O=null}});var z=new Promise(function(e){return n=e});b.openChannel({service:function(e){return e.repl.authorizations.editFileContents.isAuthorized?"gcsfiles":"files"}},function(e){var r=e.channel;n(r),x();var t=(0,l._)(I.keys()).sort(),o=!0,i=!1,a=void 0;try{for(var s,c=t[Symbol.iterator]();!(o=(s=c.next()).done);o=!0)!function(){var e=s.value;es.readDir(e).then(function(r){var n=I.get(e);if(n){if(r.error){et({eventType:T.kS.Delete,node:{path:e,type:T.Tv.Directory}});return}var t=r.children,o=n.children,i=o.filter(function(e){return!t.some(function(r){return r.filename===e.filename&&r.type===e.type})}),a=!0,l=!1,s=void 0;try{for(var c,u=i[Symbol.iterator]();!(a=(c=u.next()).done);a=!0){var f=c.value;et({eventType:T.kS.Delete,node:{path:(0,y.K1)(e,f.filename),type:f.type}})}}catch(e){l=!0,s=e}finally{try{a||null==u.return||u.return()}finally{if(l)throw s}}var d=t.filter(function(e){return!o.some(function(r){return r.filename===e.filename&&r.type===e.type})}),h=!0,p=!1,v=void 0;try{for(var g,m=d[Symbol.iterator]();!(h=(g=m.next()).done);h=!0){var C=g.value;et({eventType:T.kS.Create,node:{path:(0,y.K1)(e,C.filename),type:C.type}})}}catch(e){p=!0,v=e}finally{try{h||null==m.return||m.return()}finally{if(p)throw v}}}})}()}catch(e){i=!0,a=e}finally{try{o||null==c.return||c.return()}finally{if(i)throw a}}var u=!0,f=!1,d=void 0;try{for(var h,p=U.keys()[Symbol.iterator]();!(u=(h=p.next()).done);u=!0)!function(){var e=h.value;es.readFile(e,{fromDisk:!0}).then(function(r){var n=U.get(e);if(n){if(r.error){et({eventType:T.kS.Delete,node:{path:e,type:T.Tv.File}});return}r.content.toBuffer().equals(n.latestContent.toBuffer())||et({eventType:T.kS.Modify,node:{path:e,type:T.Tv.File}})}})}()}catch(e){f=!0,d=e}finally{try{u||null==p.return||p.return()}finally{if(f)throw d}}return function(){z=new Promise(function(e){return n=e})}});var W=(0,m.Z)();W.promise.catch(function(e){return e});var B=(0,v.Z)((0,t._)(function(){var e;return(0,s.Jh)(this,function(r){switch(r.label){case 0:return[4,W.promise];case 1:return[4,r.sent().request({fsSnapshot:{}})];case 2:if((e=r.sent()).channelClosed)return[2,{success:!1,error:"channel closed"}];if(e.error)return[2,{success:!1,error:e.error}];return[2,{error:null,success:!0}]}})}),{wait:5e3,maxWait:1e4});b.openChannel({service:"snapshot",skip:function(e){return!e.repl.authorizations.editFileContents.isAuthorized}},function(e){var r=e.channel;return W.resolve(r),function(){W.isFulfilled&&(W=(0,m.Z)()).promise.catch(function(e){return e})}});var Q=T.kO.Clean,H=[],K=0;function Y(){return G.apply(this,arguments)}function G(){return(G=(0,t._)(function(){var e;return(0,s.Jh)(this,function(r){switch(r.label){case 0:return K++,X(),[4,es.persist()];case 1:return(e=r.sent()).error&&d.kg.error("Failed to persist, something very bad has probably happened",{originalError:e.error}),K--,X(),[2]}})})).apply(this,arguments)}function X(){return $.apply(this,arguments)}function $(){return($=(0,t._)(function(){var e;return(0,s.Jh)(this,function(r){return(e=0===K&&0===j.length&&Array.from(L.values()).every(function(e){return e.otClient.isClean()}))===(Q===T.kO.Clean)||(Q=e?T.kO.Clean:T.kO.Syncing,H.forEach(function(e){e(Q,{hasUserChanged:F})})),[2]})})).apply(this,arguments)}var j=[];function ee(e){F=!0,j.push(e),X(),e.then(function(){var r=j.indexOf(e);r>-1&&j.splice(r,1),Y()})}function er(e,r){return en.apply(this,arguments)}function en(){return(en=(0,t._)(function(e,r){var n,o;return(0,s.Jh)(this,function(i){var a;return a=(0,t._)(function(){var r,t,o;return(0,s.Jh)(this,function(i){switch(i.label){case 0:return[4,z];case 1:if("open"!==(r=i.sent()).status)return[2,k(n)];i.label=2;case 2:return i.trys.push([2,4,,5]),[4,r.request(e)];case 3:return t=i.sent(),[3,5];case 4:return o=i.sent(),f.Tb(Error("Send request failed with error: ".concat(o))),[2,k(n)];case 5:if(t.channelClosed)return[2,k(n)];return[2,t]}})}),o=(n=function(){return a.apply(this,arguments)})(),r.isMutative&&ee(o),[2,o]})})).apply(this,arguments)}function et(e){P=null;var r=(0,y.DH)(e.node.path),n=I.get(r),t=(0,y.Bf)(e.node.path);if(!t)throw Error("Expected filename");var a=null;if(e.eventType===T.kS.Move){var s=(0,y.DH)(e.to);a=I.get(s)}if(n||a)switch(e.eventType){case T.kS.Create:if(!n)break;var c=(0,l._)(n.children.filter(function(e){return e.filename!==t})).concat([{type:e.node.type,filename:t}]),u=!0,d=!1,h=void 0;try{for(var p,v=n.listeners[Symbol.iterator]();!(u=(p=v.next()).done);u=!0)(0,p.value.onChange)(c)}catch(e){d=!0,h=e}finally{try{u||null==v.return||v.return()}finally{if(d)throw h}}n.children=c;break;case T.kS.Move:var g=(0,y.Bf)(e.to);if(n&&n===a){var m=(0,l._)(n.children.filter(function(e){return e.filename!==t&&e.filename!==g})).concat([{type:e.node.type,filename:g}]),C=!0,w=!1,E=void 0;try{for(var b,S=n.listeners[Symbol.iterator]();!(C=(b=S.next()).done);C=!0)(0,b.value.onChange)(m)}catch(e){w=!0,E=e}finally{try{C||null==S.return||S.return()}finally{if(w)throw E}}n.children=m;break}if(n){var D=n.children.filter(function(e){return e.filename!==t}),_=!0,k=!1,x=void 0;try{for(var F,O=n.listeners[Symbol.iterator]();!(_=(F=O.next()).done);_=!0)(0,F.value.onChange)(D)}catch(e){k=!0,x=e}finally{try{_||null==O.return||O.return()}finally{if(k)throw x}}n.children=D}if(a){var R=(0,l._)(a.children.filter(function(e){return e.filename!==t&&e.filename!==g})).concat([{type:e.node.type,filename:g}]),M=!0,N=!1,A=void 0;try{for(var J,V=a.listeners[Symbol.iterator]();!(M=(J=V.next()).done);M=!0)(0,J.value.onChange)(R)}catch(e){N=!0,A=e}finally{try{M||null==V.return||V.return()}finally{if(N)throw A}}a.children=R}break;case T.kS.Delete:if(!n)break;var q=n.children.filter(function(e){return e.filename!==t}),Z=!0,z=!1,W=void 0;try{for(var B,Q=n.listeners[Symbol.iterator]();!(Z=(B=Q.next()).done);Z=!0)(0,B.value.onChange)(q)}catch(e){z=!0,W=e}finally{try{Z||null==Q.return||Q.return()}finally{if(z)throw W}}n.children=q;break;case T.kS.Modify:break;default:throw Error("unknown event")}switch(e.eventType){case T.kS.Move:case T.kS.Delete:var H=[L.get(e.node.path),U.get(e.node.path),I.get(e.node.path)],K=!0,Y=!1,G=void 0;try{for(var X,$=H[Symbol.iterator]();!(K=(X=$.next()).done);K=!0){var j=X.value;if(j){var ee=!0,er=!1,en=void 0;try{for(var eo,ei=j.listeners[Symbol.iterator]();!(ee=(eo=ei.next()).done);ee=!0){var ea=eo.value,el=ea.onMoveOrDelete,ec=ea.dispose;el&&el(e),ec()}}catch(e){er=!0,en=e}finally{try{ee||null==ei.return||ei.return()}finally{if(er)throw en}}}}}catch(e){Y=!0,G=e}finally{try{K||null==$.return||$.return()}finally{if(Y)throw G}}if(e.node.type===T.Tv.File)break;var eu=(0,l._)(new Set((0,l._)(I.keys()).concat((0,l._)(U.keys()),(0,l._)(L.keys())))).map(function(e){var r=L.get(e)||U.get(e)||I.get(e);if(!r)throw Error("expected node");return r}),ef=[],ed=!0,eh=!1,ep=void 0;try{for(var ev,eg=eu.sort()[Symbol.iterator]();!(ed=(ev=eg.next()).done);ed=!0){var em=ev.value;if((0,y.X2)(e.node.path,em.path)){var ey=ef.slice(-1)[0];if(!(ey&&(0,y.X2)(ey,em.path))){var eC={eventType:T.kS.Delete,node:{path:em.path,type:em.type}};e.eventType===T.kS.Move&&(eC=(0,i._)((0,o._)({},eC),{eventType:T.kS.Move,to:(0,y.eB)(e.node.path,e.to,em.path)})),ef.push(em.path),et(eC)}}}}catch(e){eh=!0,ep=e}finally{try{ed||null==eg.return||eg.return()}finally{if(eh)throw ep}}break;case T.kS.Create:case T.kS.Modify:if(!U.has(e.node.path))break;es.readFile(e.node.path,{fromDisk:!0}).then(function(r){var n=U.get(e.node.path);if(n){if(r.error){et({eventType:T.kS.Delete,node:{path:e.node.path,type:T.Tv.File}});return}n.latestContent=r.content;var t=!0,o=!1,i=void 0;try{for(var a,l=n.listeners[Symbol.iterator]();!(t=(a=l.next()).done);t=!0){var s=a.value.onChange;s&&s(r.content)}}catch(e){o=!0,i=e}finally{try{t||null==l.return||l.return()}finally{if(o)throw i}}}}).catch(function(e){e.message="File read after modify error: "+e.message,f.Tb(e)})}}function eo(e){var r=!0,n=!1,t=void 0;try{for(var o,i=V[Symbol.iterator]();!(r=(o=i.next()).done);r=!0)(0,o.value)(e)}catch(e){n=!0,t=e}finally{try{r||null==i.return||i.return()}finally{if(n)throw t}}}function ei(){return(ei=(0,t._)(function(){var e,r,n,t,o,i,a;return(0,s.Jh)(this,function(s){switch(s.label){case 0:if(!(null===(n=b.getContext())||void 0===n?void 0:null===(r=n.repl)||void 0===r?void 0:r.language))throw Error("Expected repl language");return[4,(e=b).execImmediately.apply(e,["rg","--hidden","--files"].concat((0,l._)(w.hD.flatMap(function(e){return["--glob","!".concat(e)]}))))];case 1:if(o=(t=s.sent()).output,i=t.error,a=function(e){return!(!e||(0,w.Ci)(e))},!i&&o)return[2,P={error:null,files:o.split("\n").filter(a)}];return"exit status 1"!==i&&f.Tb(Error("Find file command failed with error: ".concat(i))),[2,{error:i,files:null}]}})})).apply(this,arguments)}var ea=(r=(0,t._)(function(e,r,n){var o,i,a,l,c,u,f,d,p=arguments;function v(e){return g.apply(this,arguments)}function g(){return(g=(0,t._)(function(e){var r;return(0,s.Jh)(this,function(n){switch(n.label){case 0:return[4,o.request(e)];case 1:if((r=n.sent()).channelClosed)throw Error("channelClosed");if(r.error)throw Error(r.error);return[2,r]}})})).apply(this,arguments)}return(0,s.Jh)(this,function(t){switch(t.label){case 0:if(!(p.length>3&&void 0!==p[3]&&p[3])&&e===E.wL)return[2,{error:T.Df.InvalidPath}];return[4,z];case 1:o=t.sent(),i={eventType:T.kS.Create,node:{path:e,type:T.Tv.File}},t.label=2;case 2:return t.trys.push([2,9,,10]),[4,v({transferStart:{path:e.toString(),size:r.length}})];case 3:if(!(a=t.sent().transfer))throw Error("Failed to start a transfer (no transfer id)");l=r.toBuffer(),c=512e3,n(l.length,0),u=0,t.label=4;case 4:if(!(u<Math.ceil(r.length/c)))return[3,7];return[4,v({transferChunk:{id:a.id,content:l.subarray(u*c,(u+1)*c)}})];case 5:t.sent(),n(l.length,Math.min(l.length,(u+1)*c)),t.label=6;case 6:return u++,[3,4];case 7:return[4,v({transferComplete:{id:a.id,crc32:h.buf(l)}})];case 8:return t.sent(),[3,10];case 9:if("channelClosed"===(f=t.sent()).message)return[2,k(es.transferFile,e,r,n)];if((d=M(f.message,[T.Df.NotDirectory,T.Df.AlreadyExists,T.Df.DiskQuotaExceeded]))===T.Df.DiskQuotaExceeded&&eo(i),d===T.Df.AlreadyExists&&(d=T.Df.IsDirectory),d)return[2,{error:d}];throw f;case 10:return et(i),[2,{error:null}]}})}),function(e,n,t){return r.apply(this,arguments)});function el(e){var r=new A(e,b,Promise.all((0,l._)(j).map(function(e){return e.catch(function(){})})).then(function(){}),b.logger,S,D);return r.on("commitComplete",Y),r.on("fileDirty",X),r.on("fileClean",X),r.on("commitStart",X),r}var es={getStatus:function(){return Q},onStatusChange:function(e){return H.push(e),function(){var r=H.indexOf(e);r>-1&&H.splice(r,1)}},watchDir:function(e,r){var n=!1,t=function(){n=!0;var r=I.get(e);r&&(r.listeners=r.listeners.filter(function(e){return e.dispose!==t}),0===r.listeners.length&&I.delete(e))};return es.readDir(e).then(function(a){if(!n){if(a.error){var l=Error(a.error);l.code=a.error,r.onError(l),t();return}var s=I.get(e);!s&&(s={path:e,type:T.Tv.Directory,children:a.children,listeners:[]},I.set(e,s),O&&O.send({subscribeFile:{files:[{path:e.toString()}]}})),s.listeners.push((0,i._)((0,o._)({},r),{dispose:t})),r.onChange(a.children)}}).catch(function(e){t(),r.onError(e)}),t},watchPathStat:function(e,r){var n=0,t=!1,o=function(i,l,s){if(l===T.Tv.File)return function(){};var c=(0,a._)(s),u=c[0],f=c.slice(1),d=u===e;if(d&&0!==f.length)throw Error("Invariant: child is target but has more children");var h=null,p=es.watchDir(i,{onChange:function(i){var a=i.find(function(e){return e.filename===(0,y.Bf)(u)});if(!a){t||(r.onNewStat({exists:!1}),t=!0),h&&(h.dispose(),h=null);return}if(h&&a.type!==h.node.type&&(h.dispose(),h=null),!h){if(d){var l=++n;es.stat(e).then(function(e){l===n&&e.exists&&(r.onNewStat(e),t=!1,h={node:a,dispose:function(){}})});return}h={node:a,dispose:o(u,a.type,f)}}},onError:r.onError});return function(){null==h||h.dispose(),p()}},i=(0,a._)((0,y.nV)(e)),l=i[0],s=i.slice(1);return o(l,T.Tv.Directory,s)},watchFilePath:function(e,r){var n,t=function(e,n){if(0===n.length){var o=es.watchFile((0,y.S1)(e),r);return function(){o()}}var i,a=n[0],l=!1,s=es.watchDir((0,y.S1)(e),{onChange:function(r){var o=r.find(function(e){return e.filename.toString()===a});if(!l&&o){i=t("".concat(e,"/").concat(a),n.slice(1)),l=!0;return}l=!1},onMoveOrDelete:function(){null==i||i()},onError:function(){}});return function(){null==i||i(),s()}},o=e.toString().split("/"),i=!1,a=es.watchDir((0,y.S1)(""),{onChange:function(e){var r=e.find(function(e){return e.filename.toString()===o[0]});if(!i&&r){n=t(o[0],o.slice(1)),i=!0;return}i=!1},onError:function(){}});return function(){null==n||n(),a()}},writeFile:function(e,r){return(0,t._)(function(){var n,t,o,i,a,l;return(0,s.Jh)(this,function(s){switch(s.label){case 0:return t="string"==typeof r?p.Z.from(r).toBuffer():r.toBuffer(),[4,er({write:{path:e.toString(),content:t}},{isMutative:!0})];case 1:if(o=s.sent(),a=null===(n=I.get((0,y.DH)(e)))||void 0===n?void 0:n.children.some(function(r){return r.filename===(0,y.Bf)(e)}),i=U.has(e)||L.has(e)||a?{eventType:T.kS.Modify,node:{path:e,type:T.Tv.File}}:{eventType:T.kS.Create,node:{path:e,type:T.Tv.File}},o.error){if((l=M(o.error,[T.Df.NotDirectory,T.Df.AlreadyExists,T.Df.DiskQuotaExceeded]))===T.Df.DiskQuotaExceeded&&eo(i),l===T.Df.AlreadyExists&&(l=T.Df.IsDirectory),!l)throw Error(o.error);return[2,{error:l}]}return et(i),[2,{error:null}]}})})()},transferFile:function(){for(var e=arguments.length,r=Array(e),n=0;n<e;n++)r[n]=arguments[n];return(0,t._)(function(){var e;return(0,s.Jh)(this,function(n){return ee(e=ea.apply(void 0,(0,l._)(r))),[2,e]})})()},readFile:function(e){var r=(arguments.length>1&&void 0!==arguments[1]?arguments[1]:{fromDisk:!1}).fromDisk;return(0,t._)(function(){var n,t,o;return(0,s.Jh)(this,function(i){switch(i.label){case 0:if(!r&&(n=L.get(e))&&n.otClient.getRawLocalContent()&&!n.otClient.isReconnecting)return[2,{content:p.Z.from(n.otClient.getRawLocalContent()),error:null}];return[4,er({read:{path:e.toString()}},{isMutative:!1})];case 1:if((t=i.sent()).error){if(!(o=M(t.error,[T.Df.NotFound,T.Df.IsDirectory])))throw Error(t.error);return[2,{error:o}]}if(!t.file||!t.file.path||!t.file.content)throw Error("Expected file");return[2,{content:p.Z.from(t.file.content),error:null}]}})})()},createDir:function(e){return(0,t._)(function(){var r,n,t;return(0,s.Jh)(this,function(o){switch(o.label){case 0:return[4,er({mkdir:{path:e.toString()}},{isMutative:!0})];case 1:if(r=o.sent(),n={eventType:T.kS.Create,node:{path:e,type:T.Tv.Directory}},r.error){if((t=M(r.error,[T.Df.NotDirectory,T.Df.DiskQuotaExceeded]))===T.Df.DiskQuotaExceeded&&eo(n),!t)throw Error(r.error);return[2,{error:t}]}return et(n),[2,{error:null}]}})})()},moveDir:function(e,r){return(0,t._)(function(){var n,t,o;return(0,s.Jh)(this,function(i){switch(i.label){case 0:return[4,er({move:{oldPath:e.toString(),newPath:r.toString()}},{isMutative:!0})];case 1:if(n=i.sent(),t={eventType:T.kS.Move,node:{path:e,type:T.Tv.Directory},to:r},n.error){if((o=M(n.error,[T.Df.NotFound,T.Df.AlreadyExists,T.Df.NotDirectory,T.Df.DiskQuotaExceeded]))===T.Df.DiskQuotaExceeded&&eo(t),!o)throw Error(n.error);return[2,{error:o}]}return et(t),[2,{error:null}]}})})()},moveFile:function(e,r){return(0,t._)(function(){var n,t,o;return(0,s.Jh)(this,function(i){switch(i.label){case 0:return[4,er({move:{oldPath:e.toString(),newPath:r.toString()}},{isMutative:!0})];case 1:if(n=i.sent(),t={eventType:T.kS.Move,node:{path:e,type:T.Tv.File},to:r},n.error){if((o=M(n.error,[T.Df.NotFound,T.Df.AlreadyExists,T.Df.NotDirectory,T.Df.DiskQuotaExceeded]))===T.Df.DiskQuotaExceeded&&eo(t),!o)throw Error(n.error);return[2,{error:o}]}return et(t),[2,{error:null}]}})})()},copyFile:function(e,r){return(0,t._)(function(){var n;return(0,s.Jh)(this,function(t){switch(t.label){case 0:return[4,es.readFile(e)];case 1:if((n=t.sent()).error)return[2,n];return[2,es.writeFile(r,n.content)]}})})()},copyDirFromRemote:function(e,r,n){return(0,t._)(function(){var t,o,i,a,l,c,u,f,d,h,p,v,g;return(0,s.Jh)(this,function(s){switch(s.label){case 0:return[4,this.deleteDir(e)];case 1:return s.sent(),[4,n.readDir(e)];case 2:if((t=s.sent()).error)return[2,t];return[4,this.readDir(r)];case 3:if((o=s.sent()).error!==T.Df.NotFound)return[3,5];return[4,this.createDir(e)];case 4:return s.sent(),[3,6];case 5:if(o.error===T.Df.NotDirectory)return[2,o];s.label=6;case 6:i=!0,a=!1,l=void 0,s.label=7;case 7:s.trys.push([7,15,16,17]),c=t.children[Symbol.iterator](),s.label=8;case 8:if(i=(u=c.next()).done)return[3,14];if(f=u.value,d=(0,y.K1)(e,f.filename),f.type!==T.Tv.File)return[3,11];return[4,n.readFile(d)];case 9:if((h=s.sent()).error)return[2,h];return[4,this.writeFile((0,y.K1)(r,f.filename),h.content)];case 10:if((p=s.sent()).error)return[2,p];return[3,13];case 11:if(f.type!==T.Tv.Directory)return[3,13];return[4,this.copyDirFromRemote(d,(0,y.K1)(r,f.filename),n)];case 12:if((v=s.sent()).error)return[2,v];s.label=13;case 13:return i=!0,[3,8];case 14:return[3,17];case 15:return g=s.sent(),a=!0,l=g,[3,17];case 16:try{i||null==c.return||c.return()}finally{if(a)throw l}return[7];case 17:return[2,{error:null}]}})}).apply(this)},copyFileFromRemote:function(e,r,n){return(0,t._)(function(){var t,o;return(0,s.Jh)(this,function(i){switch(i.label){case 0:return[4,n.readFile(e)];case 1:if((t=i.sent()).error)return[2,t];return[4,this.writeFile(r,t.content)];case 2:if((o=i.sent()).error)return[2,o];return[2,{error:null}]}})}).apply(this)},deleteFile:function(e){return(0,t._)(function(){var r,n;return(0,s.Jh)(this,function(t){switch(t.label){case 0:return[4,er({remove:{path:e.toString()}},{isMutative:!0})];case 1:if((r=t.sent()).error){if(!(n=M(r.error,[T.Df.NotFound])))throw Error(r.error);return[2,{error:n}]}return et({eventType:T.kS.Delete,node:{path:e,type:T.Tv.File}}),[2,{error:null}]}})})()},deleteDir:function(e){return(0,t._)(function(){var r,n;return(0,s.Jh)(this,function(t){switch(t.label){case 0:return[4,er({remove:{path:e.toString()}},{isMutative:!0})];case 1:if((r=t.sent()).error){if(!(n=M(r.error,[T.Df.NotFound])))throw Error(r.error);return[2,{error:n}]}return et({eventType:T.kS.Delete,node:{path:e,type:T.Tv.Directory}}),[2,{error:null}]}})})()},readDir:function(e){return(0,t._)(function(){var r,n,t;return(0,s.Jh)(this,function(o){switch(o.label){case 0:return[4,er({readdir:{path:e.toString()}},{isMutative:!1})];case 1:if((n=o.sent()).error){if(!(t=M(n.error,[T.Df.NotFound,T.Df.NotDirectory,T.Df.FileSystemUnavailable])))throw Error(n.error);return[2,{error:t}]}if(!(null===(r=n.files)||void 0===r?void 0:r.files))throw Error("Expected filesChannel");return[2,{children:n.files.files.map(function(e){if(!e.path)throw Error("Expected path");return{filename:(0,y.Bf)((0,y.S1)(e.path)),type:e.type===u.api.File.Type.DIRECTORY?T.Tv.Directory:T.Tv.File}}),error:null}]}})})()},stat:function(e){return(0,t._)(function(){var r;return(0,s.Jh)(this,function(n){switch(n.label){case 0:return[4,er({stat:{path:e.toString()}},{isMutative:!1})];case 1:if((r=n.sent()).error)throw Error(r.error);if(!r.statRes)throw Error("expected stat result");if(!r.statRes.exists)return[2,{exists:!1}];if(r.statRes.type===u.api.File.Type.DIRECTORY)return[2,{exists:!0,type:T.Tv.Directory,lastModified:new Date(1e3*r.statRes.modTime)}];return[2,{exists:!0,type:T.Tv.File,lastModified:new Date(1e3*r.statRes.modTime),byteLength:Number(r.statRes.size)}]}})})()},watchTextFile:function(e,r){var n=this;if(!(0,y.O5)(e)&&(0,y.C_)((0,y.S1)(e)))throw Error("Cannot watch root directory");var a=L.get(e);if(a||(a={path:e,type:T.Tv.File,listeners:[],otClient:el(e)},L.set(e,a)),!a)throw Error("Expected watchedOtFile");var u=!1,f=!1,d=function(){},h=[],p=function(o){if(d(),!a)throw Error("Expected watchedOtFile");var i,m,y,C,w,E=function(e){var n;return null===(n=r.onFlush)||void 0===n?void 0:n.call(r,e)};a.otClient.on("commitComplete",E);var b=function(){var e;return null===(e=r.onStatusChange)||void 0===e?void 0:e.call(r,T.KF.Dirty)};a.otClient.on("fileDirty",b);var S=function(){var e;return null===(e=r.onStatusChange)||void 0===e?void 0:e.call(r,T.KF.Clean)};a.otClient.on("fileClean",S);var D=function(){var e;return null===(e=r.onStatusChange)||void 0===e?void 0:e.call(r,T.KF.Syncing)};a.otClient.on("commitStart",D);var _=function(e){var n;return null===(n=r.onCursor)||void 0===n?void 0:n.call(r,e)};a.otClient.on("cursor",_);var k=function(e){var n;return null===(n=r.onRemoveCursor)||void 0===n?void 0:n.call(r,e)};a.otClient.on("removeCursor",k);var x=function(e){var n;return null===(n=r.onFileSavedChanged)||void 0===n?void 0:n.call(r,e)};a.otClient.on("fileSavedChanged",x);var O=(i=(0,t._)(function(r){var t,o,i,l,c,u,f,d,p,v,m,y;return(0,s.Jh)(this,function(s){switch(s.label){case 0:if(!a)throw Error("Expected watchedOtFile");return(t=a.otClient).destroy(),o=el(e),[4,new Promise(function(e,r){o.once("changes",function(){return e()}),o.once("error",function(e){return r(e)})})];case 1:if(s.sent(),i=t.getLocalContent(),l=o.getLocalContent(),c="local"===r?(0,g.F)(l,i):null,u="remote"===r?(0,g.F)(i,l):null,!a)throw Error("Expected watchedOtFile");a.otClient=o,f=!0,d=!1,p=void 0;try{for(v=a.listeners[Symbol.iterator]();!(f=(m=v.next()).done);f=!0)(0,m.value.reregister)(u)}catch(e){d=!0,p=e}finally{try{f||null==v.return||v.return()}finally{if(d)throw p}}for(c&&o.writeChanges(c);h.length>0;)null===(y=h.pop())||void 0===y||y({isDisposed:!1});return[4,n.flush()];case 2:return s.sent(),[2]}})}),function(e){return i.apply(this,arguments)}),R=function(e){var n;return null===(n=r.onReconnectFail)||void 0===n?void 0:n.call(r,O,e)};a.otClient.on("promptUserReconnect",R),a.listeners[0].reregister===p&&a.otClient.on("promptUserReconnect",function(){if(L.has(e)){if(!a)throw Error("Expected watchedOtFile");a.listeners.some(function(e){return e.onReconnectFail})||O("remote")}});var M=function(e,n){r.onError&&r.onError(e,n),v()};a.otClient.on("error",M);var P=function(n,t){if(n===T.Df.DiskQuotaExceeded&&eo({eventType:T.kS.Modify,node:{path:e,type:T.Tv.File}}),r.onError){var o=Error(t);o.code=n,r.onError(o)}v()};a.otClient.on("fsError",P);var N=function(e,n){if(!a)throw Error("Expected watchedOtFile");F=!0;var t=c.as.of(e,a.otClient.getLocalContent().length,"\n");a.otClient.writeChanges(t,n);var o=!0,i=!1,l=void 0;try{for(var s,u=a.listeners[Symbol.iterator]();!(o=(s=u.next()).done);o=!0){var f=s.value.onChange;f&&f!==r.onChange&&f({changes:t,changeSource:T.Fl.Local,version:a.otClient.version,latestContent:a.otClient.getLocalContent()})}}catch(e){i=!0,l=e}finally{try{o||null==u.return||u.return()}finally{if(i)throw l}}},I=(m=(0,t._)(function(){return(0,s.Jh)(this,function(e){return(null==a?void 0:a.otClient.isReconnecting)?[2,new Promise(function(e,r){if(!a){r(Error("Expected watchedOtFile"));return}h.push(e)})]:[2,{isDisposed:u}]})}),function(){return m.apply(this,arguments)}),A=function(){for(;h.length>0;){var e;null===(e=h.pop())||void 0===e||e({isDisposed:!1})}};a.otClient.on("transparentReconnect",A);var J=(y=(0,t._)(function(){var e,r,n,t,o,i=arguments;return(0,s.Jh)(this,function(s){switch(s.label){case 0:for(r=Array(e=i.length),n=0;n<e;n++)r[n]=i[n];if(!a)throw Error("Expected watchedOtFile");s.label=1;case 1:return s.trys.push([1,3,,4]),[4,I()];case 2:if(s.sent().isDisposed)return[2,{isDisposed:!0,result:null}];return[3,4];case 3:if(o=s.sent(),u)return[2,{isDisposed:!0,result:null}];throw o;case 4:return[4,(t=a.otClient).fetchChanges.apply(t,(0,l._)(r))];case 5:return[2,{isDisposed:!1,result:s.sent()}]}})}),function(){return y.apply(this,arguments)}),U=(C=(0,t._)(function(){var e,r,n,t,o=arguments;return(0,s.Jh)(this,function(i){switch(i.label){case 0:for(r=Array(e=o.length),n=0;n<e;n++)r[n]=o[n];if(!a)throw Error("Expected watchedOtFile");return[4,I()];case 1:if(i.sent().isDisposed)throw Error("File was disposed");return[2,(t=a.otClient).transformSelection.apply(t,(0,l._)(r))]}})}),function(){return C.apply(this,arguments)}),V=function(e){if(!a)throw Error("Expected watchedOtFile");a.otClient.updateCursors(e)};-1!==a.otClient.version&&setTimeout(function(){var e;if(!f){if(!a)throw Error("Expected watchedOtFile");f=!0,null===(e=r.onReady)||void 0===e||e.call(r,{initialContent:a.otClient.getLocalContent(),writeChange:N,updateSelections:V,fetchChanges:J,transformSelection:U,version:a.otClient.version})}}),o&&(null===(w=r.onChange)||void 0===w||w.call(r,{changes:o,changeSource:T.Fl.Container,version:a.otClient.version,latestContent:a.otClient.getLocalContent(),userId:0}));var q=function(e,n){var t,o;if(!a)throw Error("Expected watchedOtFile");if(!f){f=!0,null===(o=r.onReady)||void 0===o||o.call(r,{initialContent:a.otClient.getLocalContent(),writeChange:N,updateSelections:V,fetchChanges:J,transformSelection:U,version:a.otClient.version});return}null===(t=r.onChange)||void 0===t||t.call(r,{changes:e,changeSource:T.Fl.Container,version:a.otClient.version,latestContent:a.otClient.getLocalContent(),userId:n})};a.otClient.on("changes",q),d=function(){if(!a)throw Error("Expected watchedOtFile");a.otClient.removeListener("commitComplete",E),a.otClient.removeListener("fileDirty",b),a.otClient.removeListener("fileClean",S),a.otClient.removeListener("commitStart",D),a.otClient.removeListener("error",M),a.otClient.removeListener("fsError",P),a.otClient.removeListener("changes",q),a.otClient.removeListener("cursor",_),a.otClient.removeListener("removeCursor",k),a.otClient.removeListener("promptUserReconnect",R),a.otClient.removeListener("transparentReconnect",A),a.otClient.removeListener("fileSavedChanged",x)},X()},v=function(){for(;h.length>0;){var r;null===(r=h.pop())||void 0===r||r({isDisposed:!0})}if(!u&&L.has(e)){if(u=!0,f=!0,d(),!a)throw Error("Expected watchedOtFile");a.listeners=a.listeners.filter(function(e){return e.dispose!==v}),0===a.listeners.length&&(a.otClient.destroy(),L.delete(e))}};return a.listeners.push((0,i._)((0,o._)({},r),{dispose:v,reregister:p})),p(null),v},watchFile:function(e,r){if(!(0,y.O5)(e)&&(0,y.C_)((0,y.S1)(e)))throw Error("Cannot watch root directory");var n=!1,t=function(){n=!0;var r=U.get(e);r&&(r.listeners=r.listeners.filter(function(e){return e.dispose!==t}),0===r.listeners.length&&U.delete(e))};return es.readFile(e).then(function(a){if(!n){if(a.error){var l=Error(a.error);l.code=a.error,r.onError&&r.onError(l),t();return}var s=U.get(e);if(!s&&(s={path:e,type:T.Tv.File,listeners:[],latestContent:a.content},U.set(e,s),O&&O.send({subscribeFile:{files:[{path:e.toString()}]}})),!s)throw Error("Expected watched file");s.listeners.push((0,i._)((0,o._)({},r),{dispose:t})),r.onChange(a.content)}}),t},listFiles:function(){return(0,t._)(function(){var e;return(0,s.Jh)(this,function(r){switch(r.label){case 0:if(P&&b.performance.now()-N<1e4)return[2,P];return R||(R=function(){return ei.apply(this,arguments)}(),N=b.performance.now()),[4,R];case 1:return e=r.sent(),R=null,[2,e]}})})()},flush:function(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:T.WL.UNKNOWN;return(0,t._)(function(){var n,o,i,a,l,c,u,f,d,h,p,v,g,m,y,C,w,E,b,S,D,_,k,x,F,O,T,R,M,P,N,I,A,J,U,V,z,W,B,Q,H,K,Y,G;return(0,s.Jh)(this,function(X){switch(X.label){case 0:var $;if($=(0,t._)(function(e){var n,t,o,i,a,l,c,u;return(0,s.Jh)(this,function(s){switch(s.label){case 0:if(n=e.path,!(t=q.get(n)))return[2];o=!0,i=!1,a=void 0,s.label=1;case 1:s.trys.push([1,6,7,8]),l=t[Symbol.iterator](),s.label=2;case 2:if(o=(c=l.next()).done)return[3,5];return[4,(0,c.value)(e.otClient.getLocalContent(),r)];case 3:s.sent(),s.label=4;case 4:return o=!0,[3,2];case 5:return[3,8];case 6:return u=s.sent(),i=!0,a=u,[3,8];case 7:try{o||null==l.return||l.return()}finally{if(i)throw a}return[7];case 8:return[2]}})}),n=function(e){return $.apply(this,arguments)},o=function(e){var n=e.path,t=!0,o=!1,i=void 0;try{for(var a,l=Z[Symbol.iterator]();!(t=(a=l.next()).done);t=!0)(0,a.value)(n,r)}catch(e){o=!0,i=e}finally{try{t||null==l.return||l.return()}finally{if(o)throw i}}},i=[],a=function(e){null===e.otClient.channel||e.otClient.isReconnecting||i.push(e.otClient.flush())},void 0!==e)return[3,9];l=!0,c=!1,u=void 0,X.label=1;case 1:X.trys.push([1,6,7,8]),f=L.values()[Symbol.iterator](),X.label=2;case 2:if(l=(d=f.next()).done)return[3,5];return h=d.value,[4,n(h)];case 3:X.sent(),X.label=4;case 4:return l=!0,[3,2];case 5:return[3,8];case 6:return p=X.sent(),c=!0,u=p,[3,8];case 7:try{l||null==f.return||f.return()}finally{if(c)throw u}return[7];case 8:v=!0,g=!1,m=void 0;try{for(y=L.values()[Symbol.iterator]();!(v=(C=y.next()).done);v=!0)w=C.value,a(w)}catch(e){g=!0,m=e}finally{try{v||null==y.return||y.return()}finally{if(g)throw m}}return[3,18];case 9:E=!0,b=!1,S=void 0,X.label=10;case 10:X.trys.push([10,15,16,17]),D=e[Symbol.iterator](),X.label=11;case 11:if(E=(_=D.next()).done)return[3,14];if(k=_.value,!(void 0!==(x=L.get(k))))return[3,13];return[4,n(x)];case 12:X.sent(),X.label=13;case 13:return E=!0,[3,11];case 14:return[3,17];case 15:return p=X.sent(),b=!0,S=p,[3,17];case 16:try{E||null==D.return||D.return()}finally{if(b)throw S}return[7];case 17:F=!0,O=!1,T=void 0;try{for(R=e[Symbol.iterator]();!(F=(M=R.next()).done);F=!0)P=M.value,N=L.get(P),void 0!==N&&a(N)}catch(e){O=!0,T=e}finally{try{F||null==R.return||R.return()}finally{if(O)throw T}}X.label=18;case 18:return X.trys.push([18,20,,21]),[4,Promise.all(i.concat(j))];case 19:if(X.sent(),void 0===e){I=!0,A=!1,J=void 0;try{for(U=L.values()[Symbol.iterator]();!(I=(V=U.next()).done);I=!0)z=V.value,o(z)}catch(e){A=!0,J=e}finally{try{I||null==U.return||U.return()}finally{if(A)throw J}}}else{W=!0,B=!1,Q=void 0;try{for(H=e[Symbol.iterator]();!(W=(K=H.next()).done);W=!0)Y=K.value,G=L.get(Y),void 0!==G&&o(G)}catch(e){B=!0,Q=e}finally{try{W||null==H.return||H.return()}finally{if(B)throw Q}}}return[3,21];case 20:return X.sent(),[3,21];case 21:return[2]}})})()},registerOnBeforeFlush:function(e,r){var n,t=null!==(n=q.get(e))&&void 0!==n?n:new Set;return t.add(r),q.set(e,t),function(){var n;return null===(n=q.get(e))||void 0===n?void 0:n.delete(r)}},registerOnFlushSuccess:function(e){return Z.add(e),function(){Z.delete(e)}},persist:function(e){var r=B();return e&&e.skipDebounce&&B.flush(),r},getOTVersion:function(e){if(e===J)return 123;var r=L.get(e);if(!r)throw Error("No file with path ".concat(e," found."));return r.otClient.version},isFileOrDirSaved:function(e){if((0,C.Mb)(e)){var r=L.get(e);return!r||r.otClient.isFileSaved()}return!0},onDiskQuotaExceeded:function(e){return V.push(e),function(){V=V.filter(function(r){return r!==e})}}};return es}},63483:function(e,r,n){"use strict";n.d(r,{ed:function(){return a},f5:function(){return c},gR:function(){return o},mt:function(){return l},tT:function(){return u},ug:function(){return i}});var t=n(80403);function o(e){return e.map(function(e){return"object"==typeof e?{delete:e.d}:"number"==typeof e?{skip:e}:{insert:e}})}function i(e){return e.map(function(e){if("delete"in e&&e.delete)return{d:e.delete};if("skip"in e&&e.skip)return e.skip;if("insert"in e&&"string"==typeof e.insert)return e.insert;throw Error("Unexpected op type")})}function a(e,r){var n=[],t=r,o=0,i=0,a=0,l=0,s=function(e){var n=e-i;if(e<i)throw Error("expected changeset to be ordered");for(var t=i+a;t<i+n+a;t++){var o=r.charCodeAt(t);o>=55296&&o<=57343?(l++,t++):13===o&&10===r.charCodeAt(t+1)&&(a++,t++)}i+=n};return e.iterChanges(function(e,r,c,u,f){if(e>0){var d=i+a,h=d-l;s(e);var p=i+a,v=p-l;n.push(v-h),o+=p-d}if(e!==r){var g=i+a,m=g-l;s(r);var y=i+a,C=y-l;n.push({d:C-m}),t=t.slice(0,o)+t.slice(o+(y-g))}if(f.length){var w=f.sliceString(0);n.push(w),t=t.slice(0,o)+w+t.slice(o),o+=w.length}}),{op:n,docAfter:t}}function l(e,r){var n=[],o=r,i=0,a=0,l=0,s=0,c=function(e){for(var n=a+l;n<a+e+l;n++){var t=r.charCodeAt(n);t>=55296&&t<=57343?(l++,n++):13===t&&10===r.charCodeAt(n+1)&&(s++,n++)}a+=e},f=!0,d=!1,h=void 0;try{for(var p,v,g=e[Symbol.iterator]();!(f=(v=g.next()).done);f=!0){var m=v.value;if("string"==typeof m){var y=m;o=o.slice(0,i)+y+o.slice(i),i+=y.length;var C=a+l;if(y.endsWith("\r")&&"\n"===r.slice(C,C+1)&&(y=y.slice(0,-1),0===y.length))continue;var w=u(y),E=C-s;(null==p?void 0:p.to)===E?p.insert=p.insert?p.insert.append(w):w:(p={from:C-s,insert:w},n.push(p))}else if("number"==typeof m){var b=l;c(m);var S=l-b;i+=m+S}else if("d"in m){var D=a+l,_=s;c(m.d);var k=a+l,x=k-D;o=o.slice(0,i)+o.slice(i+x);var F=D-_,O=k-s;if("\r\n"===r.slice(D-1,D+1)&&(F+=1,(O-=1)-F<=0))continue;(null==p?void 0:p.to)===F?p.to=O:(p={from:F,to:O},n.push(p))}}}catch(e){d=!0,h=e}finally{try{f||null==g.return||g.return()}finally{if(d)throw h}}if(a+l!==r.length){var T=r.slice(a+l);s+=T.split("\r\n").length-1}return{changes:t.as.of(n,r.length-s),docAfter:o}}var s=/\r\n?|\n/;function c(e){return e.replaceAll("\r\n","\n").replaceAll("\r","\n")}function u(e){return t.xv.of(e.split(s))}},44816:function(){}}]);
//# sourceMappingURL=6756-4b1544bea4d4ec1e.js.map